#!/bin/bash
echo "Installing Whisper Key {{VERSION}}..."

# Clean up old VoxVibe installations to prevent conflicts
echo "ðŸ§¹ Cleaning up old VoxVibe installations..."

# Remove old VoxVibe autostart files
if [ -f ~/.config/autostart/voxvibe.desktop ]; then
    echo "  Removing old VoxVibe autostart file..."
    rm -f ~/.config/autostart/voxvibe.desktop
fi

# Remove old VoxVibe pipx installation
if pipx list | grep -q "package voxvibe"; then
    echo "  Removing old VoxVibe pipx installation..."
    pipx uninstall voxvibe || true
fi

# Remove old VoxVibe GNOME extensions
if [ -d ~/.local/share/gnome-shell/extensions/voxvibe@voxvibe.app ]; then
    echo "  Removing old VoxVibe GNOME extension..."
    rm -rf ~/.local/share/gnome-shell/extensions/voxvibe@voxvibe.app
fi

echo "âœ… Cleanup complete"

# Install WhisperKey
echo "ðŸ“¦ Installing WhisperKey..."

# Check if pipx is available
if command -v pipx >/dev/null 2>&1; then
    echo "Installing Python application with pipx..."
    pipx install app/*.whl
else
    echo "pipx not found, installing with pip..."
    pip install --user app/*.whl
fi

# Create autostart file
echo "ðŸš€ Setting up autostart..."
AUTOSTART_DIR="$HOME/.config/autostart"
AUTOSTART_FILE="$AUTOSTART_DIR/whisperkey.desktop"

# Create autostart directory if it doesn't exist
mkdir -p "$AUTOSTART_DIR"

# Create desktop file
cat > "$AUTOSTART_FILE" << 'EOF'
[Desktop Entry]
Type=Application
Name=WhisperKey
Comment=Voice dictation application for Linux
Exec=whisperkey
Icon=audio-input-microphone
Terminal=false
Hidden=false
X-GNOME-Autostart-enabled=true
StartupNotify=false
EOF

# Make the autostart file executable
chmod +x "$AUTOSTART_FILE"

# Install GNOME extension (optional)
echo "ðŸ”Œ Installing GNOME extension (optional)..."
mkdir -p ~/.local/share/gnome-shell/extensions/{{EXTENSION_UUID}}
cp -r extension/* ~/.local/share/gnome-shell/extensions/{{EXTENSION_UUID}}/

echo "Compiling extension schemas..."
glib-compile-schemas ~/.local/share/gnome-shell/extensions/{{EXTENSION_UUID}}/schemas || true

echo "Resetting extension to clear any stale state..."
gnome-extensions reset {{EXTENSION_UUID}} 2>/dev/null || true
sleep 1

echo "Enabling extension..."
gnome-extensions enable {{EXTENSION_UUID}} || echo "Please enable Whisper Key extension manually"

echo "Configuring default hotkeys (Alt+Space primary, Super+Alt+g fallback)..."
echo "Note: Using lowercase 'g' - GNOME keybindings are case-sensitive!"
gsettings reset org.gnome.shell.extensions.whisperkey toggle-recording 2>/dev/null || true
gsettings set org.gnome.shell.extensions.whisperkey toggle-recording "['<Alt>space', '<Super><Alt>g']" || true

echo "Reloading extension to register keybindings..."
gnome-extensions disable {{EXTENSION_UUID}} 2>/dev/null || true
sleep 1
gnome-extensions enable {{EXTENSION_UUID}} 2>/dev/null || true

echo ""
echo "âœ… Installation complete!"
echo ""
echo "ðŸš€ WhisperKey is now installed and ready to use."
echo "   â€¢ The application will start automatically on login"
echo "   â€¢ Look for the microphone icon in your system tray"
echo "   â€¢ Use Alt+Space (or Super+Alt+G) to toggle dictation"
echo ""
echo "Please log out and back in to activate the extension and autostart."
echo "If the hotkey doesn't work immediately, run:"
echo "  gsettings get org.gnome.shell.extensions.whisperkey toggle-recording"
echo "and ensure it shows ['<Alt>space', '<Super><Alt>G']"
